<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>DocStrap Source: foursquare.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">DocStrap</a>
	</div>
	<div class="navbar-collapse">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-foursquare.html">foursquare</a></li><li><a href="module-instagram.html">instagram</a></li><li><a href="module-maps.html">maps</a></li><li><a href="module-uber.html">uber</a></li>
				</ul>
			</li>
			
		</ul>
	</div>
</div>
</div>


<div class="container">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
    		<h1 class="page-title">Source: foursquare.js</h1>
			

		<h1 class="page-title">Source: foursquare.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 * @module foursquare
 */

var Promise = require('bluebird');
var request = require('request-promise');

var keys = {};
if (process.env.NODE_ENV === 'production') {
  keys.FOURSQUARE_ID = process.env.FOURSQUARE_ID;
  keys.FOURSQUARE_SECRET = process.env.FOURSQUARE_SECRET;
} else {
  keys = require('../config.js');
}


/**
 * Finds bars within 300m of a coordinate
 * @param  {Array} coords
 * @param {Float} coords.0 Latitude
 * @param {Float} coords.1 Longitude
 * @return {Promise.&lt;Array>}        Array of bars sorted by rating
 */
var get_foursquare_data_for_coord = function(coords) {
  return request({
    'uri': 'https://api.foursquare.com/v2/venues/explore',
    'qs': {
      'v': 20150728,
      'm': 'foursquare',
      'client_id': keys.FOURSQUARE_ID,
      'client_secret': keys.FOURSQUARE_SECRET,
      'll': coords.join(','),
      'radius': 300,
      'categoryId': '4bf58dd8d48988d116941735',
      // 'query': 'bar',
      'section': 'drinks',
      'limit': 15,
      'openNow': 0
    },
    'json': true
  });
};

/**
 * Takes an array of coordinates and fetches nearby bars from for
 * @param  {Object[]} points
 * @param {Float} points[].lat Latitude
 * @param {Float} points[].lng Longitude
 * @return {Promise.&lt;Array>} Array of results from [get_foursquare_data_for_coord]{@link module:foursquare~get_foursquare_data_for_coord}
 */
var get_foursquare_data_for_array_of_points = function(points) {
  var calls = [];

  points.forEach(function(point) {
    calls.push(get_foursquare_data_for_coord([point.lat, point.lng]));
  });

  return Promise.all(calls);
};


/**
 * Filters out unwanted bar types and sorts Foursquare results
 * @param  {Object} res Result from [get_foursquare_data_for_coord]{@link module:foursquare~get_foursquare_data_for_coord}
 * @return {Object[]}     Filtered and sorted results
 */
var filter_foursquare_data = function(res) {
  var data = res.response.groups[0].items;

  data = data.filter(function(obj) {
    return !(obj.venue.categories[0].id in {
      '4bf58dd8d48988d1d5941735': 'Hotel Bars',
      '4bf58dd8d48988d119941735': 'Hookah Bar'
    });
  });

  var with_ratings = data.filter(function(obj) {
    return obj.venue.rating !== undefined;
  });

  if (with_ratings.length) {
    data = with_ratings.sort(function(a, b) {
      if (a.venue.rating > b.venue.rating) {
        return -1;
      } else if (a.venue.rating &lt; b.venue.rating) {
        return 1;
      } else {
        return 0;
      }
    });
  } else {
    data = data.sort(function(a, b) {
      if (a.venue.stats.checkinscount > b.venue.stats.checkinscount) {
        return 1;
      } else if (a.venue.stats.checkinscount &lt; b.venue.stats.checkinscount) {
        return -1;
      } else {
        return 0;
      }
    });
  }

  return data;
};


/**
 * Choose bars from filtered and sorted results
 * @param  {Object[]} data - Result from [filter_foursquare_data]{@link module:foursquare~filter_foursquare_data}
 * @param  {Boolean} [always_top=false] - Always return the top sorted results
 *
 * @returns {Object[]} list - Array of chosen bars
 * @returns {String} list[].name - Name of venue
 * @returns {Object} list[].coordinates - Coordinates of venue
 * @returns {Float} list[].coordinates.lat - Latitude of venue
 * @returns {Float} list[].coordinates.lng - Longitude of venue
 * @returns {String} list[].address - Address of venue
 * @returns {Integer} list[].foursquare_v2_id - Foursquare id of venue
 */
var choose_foursquare_venues = function(data, always_top) {
  always_top = (always_top === undefined) ? false : always_top;
  var venue_ids = {};

  var fourSquareData = data.map(function(venues) {
    venues = venues.filter(function(venue) {
      return !(venue_ids[venue.venue.id]);
    });

    if (!venues.length) {
      return undefined;
    }

    var index = (always_top) ? 0 : Math.floor(Math.random() * venues.length);

    return {
      'name': venues[index].venue.name,
      'coordinates': {
        'lat': venues[index].venue.location.lat,
        'lng': venues[index].venue.location.lng
      },
      'address': venues[index].venue.location.formattedAddress.join(' '),
      'foursquare_v2_id': venues[index].venue.id
    };
  });

  // Filter out undefined indexes
  fourSquareData = fourSquareData.filter(function(location){
    return location !== undefined;
  });

  return fourSquareData;
};

module.exports = {
  get_foursquare_data_for_coord: get_foursquare_data_for_coord,
  get_foursquare_data_for_array_of_points: get_foursquare_data_for_array_of_points,
  filter_foursquare_data: filter_foursquare_data,
  choose_foursquare_venues: choose_foursquare_venues
};
</pre>
	</article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


<footer>


	<span class="copyright">
	DocStrap Copyright Â© 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
	</span>
	<br />

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a>
	on Fri Jul 31st 2015 using the <a
	href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
</span>
</footer>

<!--<script src="scripts/sunlight.js"></script>-->
<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/bootstrap-dropdown.js"></script>
<script src="scripts/toc.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "h1,h2,h3,h4",
		showAndHide : false,
		scrollTo    : "100px"
	} );

	$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();
	//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			lang = "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );
} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


</body>
</html>
